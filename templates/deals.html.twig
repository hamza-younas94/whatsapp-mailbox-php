{% extends "base.html.twig" %}

{% block title %}Deal History - {{ app_name }}{% endblock %}

{% block content %}
{% include "navbar.html.twig" with {'currentPage': 'deals'} %}

<div class="container-fluid deals-page">
    <div class="page-header">
        <h1>üí∞ Deal History</h1>
        <p>Track all deals and revenue across customers</p>
    </div>

    <!-- Stats Overview -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-icon" style="background: #e3f2fd;">
                    <i class="fas fa-handshake" style="color: #1976d2; font-size: 1.5rem;"></i>
                </div>
                <div class="stat-value">{{ totalDeals }}</div>
                <div class="stat-label">Total Deals</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-icon" style="background: #e8f5e9;">
                    <i class="fas fa-check-circle" style="color: #388e3c; font-size: 1.5rem;"></i>
                </div>
                <div class="stat-value">{{ wonDealsCount }}</div>
                <div class="stat-label">Won Deals</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-icon" style="background: #fff3e0;">
                    <i class="fas fa-clock" style="color: #f57c00; font-size: 1.5rem;"></i>
                </div>
                <div class="stat-value">{{ dealsByStatus['pending'] ?? 0 }}</div>
                <div class="stat-label">Pending</div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card">
                <div class="stat-icon" style="background: #e8f5e9;">
                    <i class="fas fa-dollar-sign" style="color: #25D366; font-size: 1.5rem;"></i>
                </div>
                <div class="stat-value">PKR {{ totalRevenue|number_format(0) }}</div>
                <div class="stat-label">Total Revenue</div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="GET" action="deals.php" class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Contact</label>
                    <select name="contact_id" class="form-select">
                        <option value="">All Contacts</option>
                        {% for contact in contacts %}
                            <option value="{{ contact.id }}" {{ currentContactId == contact.id ? 'selected' : '' }}>
                                {{ contact.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Status</label>
                    <select name="status" class="form-select">
                        <option value="all" {{ currentStatus == 'all' ? 'selected' : '' }}>All Status</option>
                        <option value="pending" {{ currentStatus == 'pending' ? 'selected' : '' }}>Pending</option>
                        <option value="won" {{ currentStatus == 'won' ? 'selected' : '' }}>Won</option>
                        <option value="lost" {{ currentStatus == 'lost' ? 'selected' : '' }}>Lost</option>
                        <option value="cancelled" {{ currentStatus == 'cancelled' ? 'selected' : '' }}>Cancelled</option>
                    </select>
                </div>

                <div class="col-md-4">
                    <label class="form-label">Search</label>
                    <div class="input-group">
                        <input type="text" name="search" placeholder="Search deals..." value="{{ searchQuery }}" class="form-control">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                        <a href="deals.php" class="btn btn-outline-secondary">Reset</a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Deals List -->
    <div class="deals-grid">
        {% if deals|length > 0 %}
            {% for deal in deals %}
                <div class="deal-card deal-status-{{ deal.status }}">
                    <div class="deal-card-header">
                        <div class="deal-main-info">
                            <h3 class="deal-title">{{ deal.deal_name }}</h3>
                            <div class="deal-customer">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                                </svg>
                                <a href="index.php?contact={{ deal.contact_id }}" class="customer-link">
                                    {{ deal.contact.name }}
                                </a>
                            </div>
                        </div>
                        <div class="deal-amount">
                            <span class="currency">{{ deal.currency }}</span>
                            <span class="amount">{{ deal.amount|number_format(0) }}</span>
                        </div>
                    </div>

                    <div class="deal-card-meta">
                        <span class="deal-status-badge status-{{ deal.status }}">
                            {% if deal.status == 'won' %}‚úÖ{% endif %}
                            {% if deal.status == 'pending' %}‚è≥{% endif %}
                            {% if deal.status == 'lost' %}‚ùå{% endif %}
                            {% if deal.status == 'cancelled' %}üö´{% endif %}
                            {{ deal.status|upper }}
                        </span>
                        <span class="deal-date">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,19H5V8H19M16,1V3H8V1H6V3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3H18V1M17,12H12V17H17V12Z"/>
                            </svg>
                            {{ deal.deal_date|date('M d, Y') }}
                        </span>
                        {% if deal.creator %}
                            <span class="deal-creator">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,8.39C13.57,9.4 15.42,10 17.42,10C18.2,10 18.95,9.91 19.67,9.74C19.88,10.45 20,11.21 20,12C20,16.41 16.41,20 12,20C9.39,20 7.04,18.75 5.5,16.8C6.83,15.14 8.85,14 11.11,14C11.39,14 11.66,14.03 11.93,14.05C11.37,13.69 10.87,13.24 10.46,12.71C9.33,13.08 8.31,13.72 7.46,14.56C6.56,13.5 6,12.16 6,10.71C6,8.57 7.05,6.67 8.67,5.5C9.39,6.17 10.29,6.67 11.29,6.88C11.5,6.94 11.72,6.97 11.94,7C12.39,7 12.82,6.91 13.21,6.74C13.61,6.56 13.95,6.31 14.24,6C14.63,5.58 14.92,5.07 15.08,4.5C15.18,4.18 15.24,3.84 15.24,3.5C15.24,3.41 15.24,3.32 15.23,3.23C15.89,3.5 16.5,3.87 17.05,4.32C16.96,5.13 16.64,5.88 16.14,6.5C15.64,7.13 14.96,7.58 14.21,7.81C13.86,7.91 13.5,7.96 13.13,7.96C12.58,7.96 12.05,7.85 11.57,7.65C11.08,7.45 10.66,7.16 10.32,6.8C9.97,6.44 9.7,6.02 9.53,5.56C9.36,5.1 9.28,4.61 9.28,4.11C9.28,3.61 9.36,3.12 9.53,2.66C9.7,2.2 9.97,1.78 10.32,1.42C10.59,1.15 10.89,0.93 11.22,0.76C11.48,0.26 11.84,0 12.24,0C12.64,0 13,0.26 13.26,0.76C13.59,0.93 13.89,1.15 14.16,1.42C14.51,1.78 14.78,2.2 14.95,2.66C15.12,3.12 15.2,3.61 15.2,4.11C15.2,4.38 15.17,4.64 15.12,4.89C14.95,5.57 14.59,6.18 14.09,6.68C13.59,7.18 12.98,7.54 12.3,7.71C12.05,7.76 11.79,7.79 11.52,7.79C11.25,7.79 10.99,7.76 10.74,7.71C10.06,7.54 9.45,7.18 8.95,6.68C8.45,6.18 8.09,5.57 7.92,4.89C7.87,4.64 7.84,4.38 7.84,4.11C7.84,3.36 8.05,2.65 8.42,2.03C8.79,1.41 9.3,0.91 9.91,0.56C10.52,0.21 11.21,0.03 11.93,0.03C12.34,0.03 12.74,0.09 13.12,0.21C12,0.06 10.91,0 9.87,0C5.03,0 1.11,3.92 1.11,8.76C1.11,10.91 1.86,12.89 3.12,14.46C3.91,13.46 4.93,12.66 6.11,12.12C7.29,11.58 8.58,11.29 9.93,11.29C11.28,11.29 12.57,11.58 13.75,12.12C14.93,12.66 15.95,13.46 16.74,14.46C18,12.89 18.75,10.91 18.75,8.76C18.75,7.18 18.35,5.68 17.64,4.36C16.93,3.04 15.94,1.95 14.74,1.15C13.54,0.35 12.16,0 10.71,0C8.57,0 6.67,0.77 5.21,2.03C3.75,3.29 2.82,5 2.55,6.94C2.48,7.42 2.45,7.91 2.45,8.41C2.45,9.78 2.77,11.08 3.34,12.25C3.91,13.42 4.74,14.43 5.76,15.21C6.78,15.99 7.96,16.51 9.24,16.73C10.52,16.95 11.83,16.86 13.08,16.48C14.33,16.1 15.48,15.44 16.45,14.56C17.42,13.68 18.18,12.59 18.66,11.36C19.14,10.13 19.33,8.79 19.21,7.46C19.09,6.13 18.67,4.85 17.97,3.7C17.27,2.55 16.32,1.57 15.18,0.85C14.04,0.13 12.75,0 11.45,0C10.15,0 8.86,0.13 7.72,0.85C6.58,1.57 5.63,2.55 4.93,3.7C4.23,4.85 3.81,6.13 3.69,7.46C3.57,8.79 3.76,10.13 4.24,11.36C4.72,12.59 5.48,13.68 6.45,14.56C7.42,15.44 8.57,16.1 9.82,16.48C11.07,16.86 12.38,16.95 13.66,16.73C14.94,16.51 16.12,15.99 17.14,15.21C18.16,14.43 18.99,13.42 19.56,12.25C20.13,11.08 20.45,9.78 20.45,8.41C20.45,7.91 20.42,7.42 20.35,6.94Z"/>
                                </svg>
                                {{ deal.creator.username }}
                            </span>
                        {% endif %}
                    </div>

                    {% if deal.notes %}
                        <div class="deal-card-notes">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,10H19.5L14,4.5V10M5,3H15L21,9V19A2,2 0 0,1 19,21H5C3.89,21 3,20.1 3,19V5C3,3.89 3.89,3 5,3M5,12V14H19V12H5M5,16V18H14V16H5Z"/>
                            </svg>
                            <p>{{ deal.notes }}</p>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        {% else %}
            <div class="empty-state-large">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor" opacity="0.3">
                    <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M11,17V16H9V14H13V13H10A1,1 0 0,1 9,12V9A1,1 0 0,1 10,8H11V7H13V8H15V10H11V11H14A1,1 0 0,1 15,12V15A1,1 0 0,1 14,16H13V17H11Z"/>
                </svg>
                <h3>No Deals Found</h3>
                <p>No deals match your current filters. Try adjusting your search criteria.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Toast Notification -->
<div id="toast" class="toast"></div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-submit form on filter change
document.querySelectorAll('.filter-select').forEach(select => {
    select.addEventListener('change', function() {
        this.form.submit();
    });
});
</script>
{% endblock %}
