{% extends "base.html.twig" %}

{% block title %}CRM Dashboard - {{ app_name }}{% endblock %}

{% block content %}
{% include "navbar.html.twig" with {'currentPage': 'crm'} %}

<div class="crm-dashboard">
    <!-- Stats Cards -->
    <div class="stats-grid" id="statsGrid">
        <div class="stat-card">
            <div class="stat-icon" style="background: #e3f2fd;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#1976d2">
                    <path d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/>
                </svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="totalContacts">-</div>
                <div class="stat-label">Total Contacts</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #e8f5e9;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#388e3c">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="qualifiedLeads">-</div>
                <div class="stat-label">Qualified Leads</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #fff3e0;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#f57c00">
                    <path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/>
                </svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="totalDealValue">-</div>
                <div class="stat-label">Total Deal Value</div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon" style="background: #f3e5f5;">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="#7b1fa2">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
            </div>
            <div class="stat-info">
                <div class="stat-value" id="averageScore">-</div>
                <div class="stat-label">Avg Lead Score</div>
            </div>
        </div>
    </div>
    
    <!-- Stage Filter -->
    <div class="crm-controls">
        <div class="stage-filters">
            <button class="stage-filter-btn active" data-stage="all" onclick="filterByStage('all')">All</button>
            <button class="stage-filter-btn" data-stage="new" onclick="filterByStage('new')">New</button>
            <button class="stage-filter-btn" data-stage="contacted" onclick="filterByStage('contacted')">Contacted</button>
            <button class="stage-filter-btn" data-stage="qualified" onclick="filterByStage('qualified')">Qualified</button>
            <button class="stage-filter-btn" data-stage="proposal" onclick="filterByStage('proposal')">Proposal</button>
            <button class="stage-filter-btn" data-stage="negotiation" onclick="filterByStage('negotiation')">Negotiation</button>
            <button class="stage-filter-btn" data-stage="customer" onclick="filterByStage('customer')">Customer</button>
        </div>
        
        <div class="search-box">
            <input type="text" id="crmSearch" placeholder="Search contacts...">
        </div>
    </div>
    
    <!-- Bulk Actions Toolbar -->
    <div id="bulkActionsToolbar" class="bulk-actions-toolbar" style="display: none;">
        <div class="bulk-actions-left">
            <span id="bulkActionsCount" class="bulk-actions-count">0 selected</span>
            <button onclick="clearBulkSelection()" class="btn-secondary btn-sm">Clear</button>
        </div>
        <div class="bulk-actions-right">
            <div class="bulk-actions-group">
                <label>Add Tags:</label>
                <select id="bulkTagSelect" class="crm-select crm-select-sm" onchange="applyBulkTag()">
                    <option value="">Select tag to add...</option>
                </select>
            </div>
            <div class="bulk-actions-group">
                <label>Change Stage:</label>
                <select id="bulkStageSelect" class="crm-select crm-select-sm" onchange="applyBulkStage()">
                    <option value="">Select stage...</option>
                    <option value="new">New</option>
                    <option value="contacted">Contacted</option>
                    <option value="qualified">Qualified</option>
                    <option value="proposal">Proposal</option>
                    <option value="negotiation">Negotiation</option>
                    <option value="customer">Customer</option>
                </select>
            </div>
            <button onclick="openBulkDeleteModal()" class="btn-danger btn-sm">Delete Selected</button>
        </div>
    </div>
    
    <!-- Contacts Table -->
    <div class="crm-table-container">
        <table class="crm-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" title="Select all">
                    </th>
                    <th>Name</th>
                    <th>Company</th>
                    <th>Phone</th>
                    <th>Stage</th>
                    <th>Lead Score</th>
                    <th>Deal Value</th>
                    <th>Last Activity</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="crmTableBody">
                <tr>
                    <td colspan="9" class="loading">Loading CRM data...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div id="bulkDeleteModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h2>Delete Selected Contacts</h2>
            <button onclick="closeBulkDeleteModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>Are you sure you want to delete <strong id="bulkDeleteCount">0</strong> selected contacts?</p>
            <p style="color: var(--text-secondary); font-size: 13px; margin-top: 10px;">This action cannot be undone.</p>
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="confirmBulkDelete()" class="btn-danger" style="flex: 1;">Delete</button>
                <button onclick="closeBulkDeleteModal()" class="btn-secondary" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- CRM Modal with Advanced Features -->
<div id="crmModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
        <div class="modal-header">
            <h2 id="crmModalTitle">CRM Details</h2>
            <button onclick="closeCrmModal()" class="modal-close">&times;</button>
        </div>
        <div class="modal-body" id="crmModalContent">
            <!-- Content loaded by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="assets/js/crm.js?v={{ "now"|date("U") }}"></script>
<script src="assets/js/crm-advanced.js?v={{ "now"|date("U") }}"></script>
<script>
// Make contacts available to CRM advanced functions
window.allContacts = allContacts || [];
window.contacts = allContacts || [];
</script>
{% endblock %}
