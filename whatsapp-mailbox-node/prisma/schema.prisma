// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["fullTextSearch"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH & USER MANAGEMENT
// ============================================

model User {
  id            String       @id @default(cuid())
  email         String       @unique
  username      String       @unique
  passwordHash  String
  name          String?
  avatarUrl     String?
  role          UserRole     @default(USER)
  isActive      Boolean      @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  // Relations
  conversations Conversation[]
  messages      Message[]
  contacts      Contact[]
  tags          Tag[]
  segments      Segment[]
  quickReplies  QuickReply[]
  automations   Automation[]
  notes         Note[]
  activityLogs  ActivityLog[]
  dripCampaigns DripCampaign[]

  @@index([email])
  @@index([username])
  @@index([isActive])
}

enum UserRole {
  ADMIN
  MANAGER
  AGENT
  USER
}

// ============================================
// CONTACTS & CONVERSATIONS
// ============================================

model Contact {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneNumber   String       @db.VarChar(20)
  name          String?
  email         String?
  avatarUrl     String?
  timezone      String?
  lastMessageAt DateTime?
  isBlocked     Boolean      @default(false)
  metadata      Json?        @default("{}")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  conversations Conversation[]
  messages      Message[]
  tags          TagOnContact[]
  notes         Note[]
  dripEnrollments DripEnrollment[]
  dripScheduled   DripScheduledMessage[]

  @@unique([userId, phoneNumber])
  @@index([userId])
  @@index([phoneNumber])
  @@fulltext([phoneNumber, name])
}

model Conversation {
  id            String       @id @default(cuid())
  userId        String
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId     String
  contact       Contact      @relation(fields: [contactId], references: [id], onDelete: Cascade)
  
  isActive      Boolean      @default(true)
  unreadCount   Int          @default(0)
  lastMessageAt DateTime?
  metadata      Json?        @default("{}")
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  // Relations
  messages      Message[]

  @@unique([userId, contactId])
  @@index([userId])
  @@index([isActive])
  @@index([lastMessageAt])
}

// ============================================
// MESSAGING
// ============================================

model Message {
  id                String           @id @default(cuid())
  userId            String
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId         String
  contact           Contact          @relation(fields: [contactId], references: [id], onDelete: Cascade)
  conversationId    String
  conversation      Conversation     @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  waMessageId       String?          @unique // WhatsApp message ID
  content           String?          @db.LongText
  messageType       MessageType      @default(TEXT)
  direction         MessageDirection @default(INCOMING)
  status            MessageStatus    @default(RECEIVED)
  
  // Media
  mediaUrl          String?
  mediaType         String?
  mediaFileName     String?
  
  // Metadata
  templateId        String?
  quickReplyId      String?
  tagIds            Json?            @default("[]")
  metadata          Json?            @default("{}")
  
  // Timing
  scheduledAt       DateTime?
  sendAt            DateTime?
  readAt            DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  // Relations
  reactions         Reaction[]
  notes             Note[]

  @@index([userId])
  @@index([contactId])
  @@index([conversationId])
  @@index([waMessageId])
  @@index([status])
  @@index([createdAt])
  @@fulltext([content])
}

enum MessageType {
  TEXT
  IMAGE
  VIDEO
  AUDIO
  DOCUMENT
  BUTTON
  LIST
  INTERACTIVE
  LOCATION
  CONTACT
  TEMPLATE
  REACTION
}

enum MessageDirection {
  INCOMING
  OUTGOING
}

enum MessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
  RECEIVED
}

model Reaction {
  id        String   @id @default(cuid())
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  emoji     String
  createdAt DateTime @default(now())

  @@unique([messageId, emoji])
  @@index([messageId])
}

// ============================================
// TAGGING & ORGANIZATION
// ============================================

model Tag {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  color     String?  @default("#3B82F6")
  createdAt DateTime @default(now())

  // Relations
  contacts  TagOnContact[]

  @@unique([userId, name])
  @@index([userId])
}

model TagOnContact {
  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)
  tagId     String
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  assignedAt DateTime @default(now())

  @@id([contactId, tagId])
  @@index([tagId])
}

// ============================================
// SEGMENTS & CAMPAIGNS
// ============================================

model Segment {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  criteria  Json     // Saved filter criteria
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model Campaign {
  id            String     @id @default(cuid())
  name          String
  type          CampaignType
  status        CampaignStatus @default(DRAFT)
  
  templateId    String?
  content       String?    @db.LongText
  mediaUrl      String?
  
  scheduleTime  DateTime?
  sentAt        DateTime?
  completedAt   DateTime?
  
  recipientCount Int      @default(0)
  sentCount      Int      @default(0)
  failedCount    Int      @default(0)
  
  metadata      Json?     @default("{}")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
}

enum CampaignType {
  BROADCAST
  SCHEDULED
  DRIP
  WORKFLOW
}

enum CampaignStatus {
  DRAFT
  SCHEDULED
  RUNNING
  PAUSED
  COMPLETED
  FAILED
}

// ============================================
// QUICK REPLIES & TEMPLATES
// ============================================

model QuickReply {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  title     String
  content   String   @db.LongText
  category  String?
  shortcut  String?  @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@fulltext([title, content])
}

model MessageTemplate {
  id        String   @id @default(cuid())
  name      String
  category  String
  language  String   @default("en")
  content   String   @db.LongText
  variables Json?    @default("[]")
  metadata  Json?    @default("{}")
  createdAt DateTime @default(now())

  @@unique([name, language])
}

// ============================================
// AUTOMATION & WORKFLOWS
// ============================================

model Automation {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  trigger   String   // MESSAGE_RECEIVED, CONTACT_ADDED, etc.
  actions   Json     // Array of actions to execute
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([isActive])
}

model AutoReply {
  id        String   @id @default(cuid())
  isActive  Boolean  @default(true)
  message   String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// NOTES & ACTIVITIES
// ============================================

model Note {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  contactId String?
  contact   Contact? @relation(fields: [contactId], references: [id], onDelete: SetNull)
  messageId String?
  message   Message? @relation(fields: [messageId], references: [id], onDelete: SetNull)
  
  content   String   @db.LongText
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([contactId])
  @@fulltext([content])
}

model ActivityLog {
  id        String        @id @default(cuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    ActivityType
  resourceType String?
  resourceId   String?
  details   Json?         @default("{}")
  ipAddress String?
  userAgent String?
  createdAt DateTime      @default(now())

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

enum ActivityType {
  LOGIN
  LOGOUT
  MESSAGE_SENT
  MESSAGE_RECEIVED
  CONTACT_CREATED
  CONTACT_UPDATED
  TAG_CREATED
  TAG_DELETED
  AUTOMATION_TRIGGERED
  CAMPAIGN_STARTED
}

// ============================================
// CONFIGURATION & SETTINGS
// ============================================

model AppConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String   @db.LongText
  type      ConfigType
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

enum ConfigType {
  STRING
  NUMBER
  BOOLEAN
  JSON
}

// ============================================
// DRIP CAMPAIGNS
// ============================================

model DripCampaign {
  id           String              @id @default(cuid())
  userId       String
  user         User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  description  String?             @db.Text
  triggerType  DripTriggerType
  triggerValue String?
  isActive     Boolean             @default(true)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt

  steps        DripCampaignStep[]
  enrollments  DripEnrollment[]
  scheduled    DripScheduledMessage[]

  @@index([userId])
  @@index([isActive])
}

enum DripTriggerType {
  MANUAL
  TAG_ADDED
  FORM_SUBMITTED
}

model DripCampaignStep {
  id           String              @id @default(cuid())
  campaignId   String
  campaign     DripCampaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  sequence     Int
  delayHours   Int
  message      String              @db.Text
  mediaUrl     String?
  mediaType    MessageMediaType?
  createdAt    DateTime            @default(now())

  scheduled    DripScheduledMessage[]

  @@index([campaignId])
  @@index([sequence])
}

model DripEnrollment {
  id           String              @id @default(cuid())
  campaignId   String
  campaign     DripCampaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  contactId    String
  contact      Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  currentStep  Int                 @default(0)
  status       DripEnrollmentStatus
  enrolledAt   DateTime            @default(now())
  completedAt  DateTime?

  @@unique([campaignId, contactId])
  @@index([campaignId])
  @@index([contactId])
  @@index([status])
}

enum DripEnrollmentStatus {
  ACTIVE
  COMPLETED
  CANCELLED
}

model DripScheduledMessage {
  id           String              @id @default(cuid())
  campaignId   String
  campaign     DripCampaign        @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  stepId       String
  step         DripCampaignStep    @relation(fields: [stepId], references: [id], onDelete: Cascade)
  contactId    String
  contact      Contact             @relation(fields: [contactId], references: [id], onDelete: Cascade)
  message      String              @db.Text
  mediaUrl     String?
  mediaType    MessageMediaType?
  scheduledFor DateTime
  status       ScheduledMessageStatus
  sentAt       DateTime?
  createdAt    DateTime            @default(now())

  @@index([campaignId])
  @@index([contactId])
  @@index([status])
  @@index([scheduledFor])
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String
  payload   Json
  status    Int
  error     String?
  retries   Int      @default(0)
  createdAt DateTime @default(now())

  @@index([event])
  @@index([createdAt])
}
