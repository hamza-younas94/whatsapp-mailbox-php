// Enhanced Schema with Advanced Features
// Add these models to your existing schema.prisma

// ============================================
// CONVERSATION MANAGEMENT ENHANCEMENTS
// ============================================

model ConversationStatus {
  id             String       @id @default(cuid())
  conversationId String       @unique
  status         String       @default("open") // open, closed, pending, snoozed
  priority       String       @default("normal") // low, normal, high, urgent
  assignedToId   String?
  assignedById   String?
  assignedAt     DateTime?
  lastStatusChange DateTime   @default(now())
  snoozedUntil   DateTime?
  closedAt       DateTime?
  closedById     String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([status])
  @@index([priority])
  @@index([assignedToId])
}

model Label {
  id        String              @id @default(cuid())
  userId    String
  name      String
  color     String              @default("#3B82F6")
  icon      String?
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  conversations ConversationLabel[]

  @@unique([userId, name])
  @@index([userId])
}

model ConversationLabel {
  id             String   @id @default(cuid())
  conversationId String
  labelId        String
  label          Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)
  assignedAt     DateTime @default(now())

  @@unique([conversationId, labelId])
  @@index([conversationId])
  @@index([labelId])
}

// ============================================
// BROADCAST SYSTEM
// ============================================

model Broadcast {
  id             String   @id @default(cuid())
  userId         String
  name           String
  message        String   @db.LongText
  mediaUrl       String?  @db.Text
  mediaType      String?
  status         BroadcastStatus @default(DRAFT)
  
  // Targeting
  segmentId      String?
  tagIds         Json?    @default("[]")
  contactIds     Json?    @default("[]")
  
  // Metrics
  recipientCount Int      @default(0)
  sentCount      Int      @default(0)
  deliveredCount Int      @default(0)
  readCount      Int      @default(0)
  failedCount    Int      @default(0)
  
  // Scheduling
  scheduledFor   DateTime?
  startedAt      DateTime?
  completedAt    DateTime?
  
  metadata       Json?    @default("{}")
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  recipients     BroadcastRecipient[]

  @@index([userId])
  @@index([status])
  @@index([scheduledFor])
}

enum BroadcastStatus {
  DRAFT
  SCHEDULED
  SENDING
  COMPLETED
  FAILED
  CANCELLED
}

model BroadcastRecipient {
  id          String   @id @default(cuid())
  broadcastId String
  broadcast   Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  contactId   String
  phoneNumber String
  status      BroadcastRecipientStatus @default(PENDING)
  sentAt      DateTime?
  deliveredAt DateTime?
  readAt      DateTime?
  failedAt    DateTime?
  error       String?  @db.Text
  retryCount  Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([broadcastId])
  @@index([contactId])
  @@index([status])
}

enum BroadcastRecipientStatus {
  PENDING
  SENDING
  SENT
  DELIVERED
  READ
  FAILED
}

// ============================================
// ENHANCED QUICK REPLIES
// ============================================

model QuickReplyCategory {
  id           String       @id @default(cuid())
  userId       String
  name         String
  description  String?
  icon         String?
  color        String?      @default("#6B7280")
  sortOrder    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  quickReplies QuickReply[]

  @@unique([userId, name])
  @@index([userId])
}

// Add to existing QuickReply model:
// categoryId   String?
// category     QuickReplyCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
// variables    Json?               @default("[]") // {name, placeholder, default}
// mediaUrl     String?             @db.Text
// mediaType    String?
// tags         Json?               @default("[]")

model QuickReplyUsage {
  id            String     @id @default(cuid())
  quickReplyId  String
  userId        String
  contactId     String?
  usedAt        DateTime   @default(now())

  @@index([quickReplyId])
  @@index([userId])
  @@index([usedAt])
}

// ============================================
// CUSTOM CONTACT FIELDS
// ============================================

model ContactField {
  id          String   @id @default(cuid())
  userId      String
  fieldName   String
  fieldLabel  String
  fieldType   ContactFieldType @default(TEXT)
  options     Json?    @default("[]") // For select/multiselect
  isRequired  Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  values      ContactFieldValue[]

  @@unique([userId, fieldName])
  @@index([userId])
}

enum ContactFieldType {
  TEXT
  NUMBER
  EMAIL
  PHONE
  DATE
  SELECT
  MULTISELECT
  CHECKBOX
  URL
}

model ContactFieldValue {
  id        String       @id @default(cuid())
  contactId String
  fieldId   String
  field     ContactField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  value     String       @db.Text
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  @@unique([contactId, fieldId])
  @@index([contactId])
  @@index([fieldId])
}

// ============================================
// ANALYTICS & METRICS
// ============================================

model MessageMetrics {
  id              String   @id @default(cuid())
  date            DateTime @db.Date
  userId          String
  
  // Message counts
  totalMessages   Int      @default(0)
  incomingCount   Int      @default(0)
  outgoingCount   Int      @default(0)
  
  // Response metrics
  avgResponseTime Int      @default(0) // in seconds
  totalResponses  Int      @default(0)
  
  // Engagement
  uniqueContacts  Int      @default(0)
  newContacts     Int      @default(0)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([date, userId])
  @@index([date])
  @@index([userId])
}

model CampaignMetrics {
  id         String   @id @default(cuid())
  campaignId String
  date       DateTime @db.Date
  
  // Delivery metrics
  sent       Int      @default(0)
  delivered  Int      @default(0)
  read       Int      @default(0)
  failed     Int      @default(0)
  
  // Engagement metrics
  replies    Int      @default(0)
  clicks     Int      @default(0)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([date, campaignId])
  @@index([date])
  @@index([campaignId])
}

model ContactEngagement {
  id               String   @id @default(cuid())
  contactId        String   @unique
  
  // Message counts
  totalReceived    Int      @default(0)
  totalSent        Int      @default(0)
  
  // Timing
  lastMessageAt    DateTime?
  firstMessageAt   DateTime?
  avgResponseTime  Int      @default(0) // in seconds
  
  // Engagement
  engagementScore  Float    @default(0) // 0-100
  isActive         Boolean  @default(true)
  
  // Interaction counts
  totalInteractions Int     @default(0)
  conversationCount Int     @default(0)
  
  updatedAt        DateTime @updatedAt
  createdAt        DateTime @default(now())

  @@index([engagementScore])
  @@index([isActive])
}

// ============================================
// TEAM & COLLABORATION
// ============================================

model Team {
  id          String       @id @default(cuid())
  name        String
  description String?      @db.Text
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  members     TeamMember[]
}

model TeamMember {
  id        String     @id @default(cuid())
  teamId    String
  team      Team       @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  role      TeamMemberRole @default(MEMBER)
  joinedAt  DateTime   @default(now())
  createdAt DateTime   @default(now())

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
}

enum TeamMemberRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

// ============================================
// SCHEDULED MESSAGES
// ============================================

model ScheduledMessage {
  id          String   @id @default(cuid())
  userId      String
  contactId   String
  message     String   @db.LongText
  mediaUrl    String?  @db.Text
  mediaType   String?
  scheduledFor DateTime
  status      ScheduledMessageStatus @default(PENDING)
  sentAt      DateTime?
  error       String?  @db.Text
  retryCount  Int      @default(0)
  metadata    Json?    @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([contactId])
  @@index([status])
  @@index([scheduledFor])
}

// ============================================
// MESSAGE TEMPLATES
// ============================================

model MessageTemplateCategory {
  id        String            @id @default(cuid())
  userId    String
  name      String
  icon      String?
  color     String?           @default("#6B7280")
  sortOrder Int               @default(0)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  templates MessageTemplate[]

  @@unique([userId, name])
  @@index([userId])
}

// Update existing MessageTemplate to add:
// userId       String
// categoryId   String?
// category     MessageTemplateCategory? @relation(fields: [categoryId], references: [id])
// variables    Json?    @default("[]")
// isActive     Boolean  @default(true)
// usageCount   Int      @default(0)

// ============================================
// CONVERSATION NOTES
// ============================================

model ConversationNote {
  id             String   @id @default(cuid())
  conversationId String
  userId         String
  content        String   @db.LongText
  isPinned       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([conversationId])
  @@index([userId])
  @@fulltext([content])
}

// ============================================
// SEARCH & FILTERS
// ============================================

model SavedFilter {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  filterType  String   // conversations, contacts, messages
  criteria    Json     // Filter criteria object
  isDefault   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId])
  @@index([filterType])
}

// ============================================
// WEBHOOKS & INTEGRATIONS
// ============================================

model Webhook {
  id          String   @id @default(cuid())
  userId      String
  name        String
  url         String   @db.Text
  events      Json     @default("[]") // Array of event names
  isActive    Boolean  @default(true)
  secret      String?
  headers     Json?    @default("{}")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  logs        WebhookLog[]

  @@index([userId])
  @@index([isActive])
}

// Update existing WebhookLog to add:
// webhookId    String
// webhook      Webhook @relation(fields: [webhookId], references: [id])
// attempts     Int     @default(0)
// lastAttempt  DateTime?
// nextRetry    DateTime?

// ============================================
// CONTACT IMPORT/EXPORT
// ============================================

model ImportJob {
  id            String   @id @default(cuid())
  userId        String
  fileName      String
  fileUrl       String?  @db.Text
  status        ImportStatus @default(PENDING)
  totalRecords  Int      @default(0)
  processedRecords Int   @default(0)
  successCount  Int      @default(0)
  errorCount    Int      @default(0)
  errors        Json?    @default("[]")
  startedAt     DateTime?
  completedAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ImportStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================
// CONVERSATION ARCHIVING
// ============================================

model ArchivedConversation {
  id             String   @id @default(cuid())
  conversationId String   @unique
  userId         String
  archivedAt     DateTime @default(now())
  archivedById   String
  reason         String?  @db.Text

  @@index([userId])
  @@index([archivedAt])
}

// ============================================
// MESSAGE FORWARDING
// ============================================

model ForwardedMessage {
  id                String   @id @default(cuid())
  originalMessageId String
  forwardedToContactId String
  forwardedById     String
  forwardedAt       DateTime @default(now())
  
  @@index([originalMessageId])
  @@index([forwardedToContactId])
}
